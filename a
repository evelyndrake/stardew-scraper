<?php
include 'data_functions.php';
$csvFile = fopen('data/crops_raw_data.csv', 'r');
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Stardew Scraper</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        <?php include 'style.css'; ?>
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
</head>
<body>
<h1>Stardew Scraper</h1>
<div>
<p><i>A profit calculator for the farming game <a href='https://www.stardewvalley.net/'>Stardew Valley</a> written by <a href='https://www.github.com/evelyndrake'>Evelyn Drake</a> for CSDS285 (Linux Tools and Scripting).</i></p>
</div>
<div class="controls">
    <h4>Controls</h4>
    <label for="sortToggle">Sort by Gold per Day (Descending):</label>
    <input type="checkbox" id="sortToggle">
    <br/>
    <label for="sellPriceType">Calculate Gold per Day based on:</label>
    <select id="sellPriceType">
        <option value="regular">regular quality crops</option>
        <option value="silver">silver quality crops</option>
        <option value="gold">gold quality crops</option>
    </select>
</div>
<table id="cropTable">
    <thead>
    <tr>
        <th>Seed name</th>
        <th class="gold-price-column">Gold per day</th>
        <th>Growth time</th>
        <th>Regrowth time</th>
        <th>Production per season</th>
        <th class="purchase-price-column">Cheapest purchase price</th>
        <th class="regular-price-column">Sell price (regular quality)</th>
        <th class="silver-price-column">Sell price (silver quality)</th>
        <th class="gold-price-column">Sell price (gold quality)</th>
    </tr>
    </thead>
    <tbody>
    <?php
    while (($row = fgetcsv($csvFile, 0, ',', '"', '\\')) !== false) {
        $seed_name = htmlspecialchars($row[4]);
        $growth_time = (int)htmlspecialchars($row[1]);
        $regrowth_time = (int)htmlspecialchars($row[19]);
        $sell_price_regular = (int)htmlspecialchars($row[17]);
        $sell_price_silver = (int)htmlspecialchars($row[3]);
        $sell_price_gold = (int)htmlspecialchars($row[5]);
        $production = production_per_season($growth_time, $regrowth_time);
        $purchase_prices = [
            (int)htmlspecialchars($row[10]),
            (int)htmlspecialchars($row[7]),
            (int)htmlspecialchars($row[25]),
            (int)htmlspecialchars($row[8]),
            (int)htmlspecialchars($row[21]),
            (int)htmlspecialchars($row[12]),
        ];
        $purchase_price = find_cheapest_price($purchase_prices);
        $gold_per_day = calculate_gold_per_day($production, $purchase_price, $sell_price_regular);

        echo "<tr data-regular='{$sell_price_regular}' data-silver='{$sell_price_silver}' data-gold='{$sell_price_gold}'>";
        echo "<td>{$seed_name}</td>";
        echo "<td class='gold-price-column-row' data-goldperday='" . number_format($gold_per_day, 2) . "'>" . number_format($gold_per_day, 2) . "</td>";
        echo "<td>{$growth_time}</td>";
        echo "<td>{$regrowth_time}</td>";
        echo "<td>{$production}</td>";
        echo "<td class='purchase-price-column-row'>" . htmlspecialchars($purchase_price) . "</td>";
        echo "<td class='regular-price-column-row'>" . htmlspecialchars($sell_price_regular) . "</td>";
        echo "<td class='silver-price-column-row'>" . htmlspecialchars($sell_price_silver) . "</td>";
        echo "<td class='gold-price-column-row'>" . htmlspecialchars($sell_price_gold) . "</td>";
        echo "</tr>";
    }
    ?>
    </tbody>
</table>
<script>
    // Initally, sort alphabetically by seed name
    let table = document.getElementById("cropTable").getElementsByTagName('tbody')[0];
    let rows = Array.from(table.getElementsByTagName("tr"));
    rows.sort((a, b) => {
        let nameA = a.cells[0].textContent.toLowerCase();
        let nameB = b.cells[0].textContent.toLowerCase();
        return nameA.localeCompare(nameB);
    });
    table.innerHTML = "";
    rows.forEach(row => table.appendChild(row));
    // Event listeners for controls
    // Calculate gold per day based on selected sell price type
    document.getElementById('sellPriceType').addEventListener('change', function() {
        let selectedType = this.value;
        let rows = document.querySelectorAll("#cropTable tbody tr");

        rows.forEach(row => {
            let production = parseFloat(row.cells[4].textContent) || 0;
            let purchasePrice = parseFloat(row.cells[5].textContent) || 0;
            let sellPrice = parseFloat(row.dataset[selectedType]) || 0;

            let goldPerDay = (production > 0 && purchasePrice !== null) ?
                (((production * sellPrice) - purchasePrice) / 28).toFixed(2) :
                "0.00";

            row.cells[1].textContent = goldPerDay;
        });
    });
    // Sort table descending by gold per day when checkbox is checked
    document.getElementById('sortToggle').addEventListener('change', function() {
        let table = document.getElementById("cropTable").getElementsByTagName('tbody')[0];
        let rows = Array.from(table.getElementsByTagName("tr"));

        if (this.checked) {
            rows.sort((a, b) => {
                let goldA = parseFloat(a.cells[1].textContent) || 0;
                let goldB = parseFloat(b.cells[1].textContent) || 0;
                return goldB - goldA;
            });
        } else {
            rows.sort((a, b) => {
                let nameA = a.cells[0].textContent.toLowerCase();
                let nameB = b.cells[0].textContent.toLowerCase();
                return nameA.localeCompare(nameB);
            });
        }

        table.innerHTML = "";
        rows.forEach(row => table.appendChild(row));
    });
</script>
<?php
fclose($csvFile);
?>

</body>
</html>